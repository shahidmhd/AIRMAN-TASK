# DEPLOYMENT.md — Render Cloud Deployment

## Live URLs

| Service  | URL |
|---|---|
| Frontend | https://airman-frontend.onrender.com |
| Backend API | https://airman-backend.onrender.com |
| API Docs | https://airman-backend.onrender.com/api/docs |
| Health Check | https://airman-backend.onrender.com/health |

---

## Architecture on Render

```
Render Free Tier
├── airman-frontend   (Node/Next.js Web Service)
├── airman-backend    (Node/Express Web Service)
├── airman-postgres   (PostgreSQL Database)
└── airman-redis      (Redis Instance)
```

---

## Initial Deployment (First Time)

### Step 1 — Push to GitHub

```bash
cd ~/Desktop/airman/airman
git add .
git commit -m "chore: add render.yaml and deployment config"
git push origin main
```

### Step 2 — Deploy on Render

1. Go to **https://render.com** → Sign in with GitHub
2. Click **New** → **Blueprint**
3. Connect your GitHub repo: `your-username/airman`
4. Render detects `render.yaml` automatically
5. Click **Apply** — Render creates all 4 services

### Step 3 — Run Seed Data

After first deploy, seed the demo data:

1. Go to Render Dashboard → `airman-backend` service
2. Click **Shell** tab
3. Run:
```bash
node prisma/seed.js
```

### Step 4 — Verify

```bash
curl https://airman-backend.onrender.com/health
# Expected: { "status": "ok", "timestamp": "..." }
```

---

## Environment Separation

### Development (local)
- File: `apps/backend/.env`
- Database: local PostgreSQL (`localhost:5432`)
- Redis: local Redis (`localhost:6379`)
- JWT secrets: any local value
- `NODE_ENV=development`

### Production (Render)
- All secrets set via Render Dashboard → Environment
- Database: Render Managed PostgreSQL
- Redis: Render Managed Redis
- JWT secrets: auto-generated by Render (`generateValue: true`)
- `NODE_ENV=production`

### Environment Variables Reference

| Variable | Dev | Production |
|---|---|---|
| `DATABASE_URL` | `postgresql://localhost:5432/airman_dev` | Auto from Render Postgres |
| `REDIS_URL` | `redis://localhost:6379` | Auto from Render Redis |
| `JWT_ACCESS_SECRET` | any string | Auto-generated (32+ chars) |
| `JWT_REFRESH_SECRET` | any string | Auto-generated (32+ chars) |
| `JWT_ACCESS_EXPIRES_IN` | `15m` | `15m` |
| `JWT_REFRESH_EXPIRES_IN` | `7d` | `7d` |
| `FRONTEND_URL` | `http://localhost:3000` | `https://airman-frontend.onrender.com` |
| `NODE_ENV` | `development` | `production` |
| `PORT` | `4000` | `4000` |

---

## Secrets Management

### How Render handles secrets

- All secrets are stored in **Render's encrypted environment store** — never in git
- Secrets marked `generateValue: true` in `render.yaml` are auto-generated by Render on first deploy with cryptographically secure random values
- Secrets are injected as environment variables at runtime — not written to any file
- The `.env` file is in `.gitignore` and never committed

### What is NOT in the repository

```
apps/backend/.env          # real secrets — gitignored
apps/frontend/.env.local   # real secrets — gitignored
```

### Rotating a secret on Render

1. Render Dashboard → `airman-backend` → Environment
2. Find the key (e.g. `JWT_ACCESS_SECRET`)
3. Click Edit → paste new value → Save
4. Render automatically redeploys with the new value
5. Note: rotating `JWT_ACCESS_SECRET` invalidates all active sessions — users must log in again

---

## Rollback Strategy

### Automatic rollback — Render keeps deploy history

Every deploy is versioned. To roll back:

1. Render Dashboard → `airman-backend` → **Deploys** tab
2. Find the last known-good deploy
3. Click **Redeploy** on that commit

This takes ~2 minutes and requires zero code changes.

### Database rollback

Prisma migrations are forward-only. For a breaking schema change:

**Before deploying a risky migration:**
```bash
# 1. Take a manual backup via Render Dashboard
# Render Dashboard → airman-postgres → Backups → Create Backup

# 2. Deploy the migration

# 3. If something breaks, restore the backup:
# Render Dashboard → airman-postgres → Backups → Restore
```

**Render PostgreSQL free tier** takes automatic daily backups retained for 7 days.

### Zero-downtime deploy

Render performs rolling deploys by default — the old instance stays up until the new one passes its health check at `/health`. If the health check fails, Render automatically keeps the previous version running.

---

## Redeployment (Subsequent Deploys)

Every push to `main` triggers automatic redeploy:

```bash
git add .
git commit -m "fix: your change description"
git push origin main
# Render detects the push and redeploys automatically
```

To deploy manually without a code change:
- Render Dashboard → service → **Manual Deploy** → Deploy latest commit

---

## Monitoring

- **Logs**: Render Dashboard → service → **Logs** tab (live streaming)
- **Health**: `https://airman-backend.onrender.com/health`
- **Metrics**: Render Dashboard → service → **Metrics** (CPU, memory, request count)

---

## Free Tier Limitations

Render free tier services **spin down after 15 minutes of inactivity**. First request after spin-down takes ~30 seconds (cold start). This is expected behaviour on the free tier and does not affect functionality.

For the demo video, hit the health check endpoint first to wake the service:
```bash
curl https://airman-backend.onrender.com/health
```
Then wait 30 seconds before recording.